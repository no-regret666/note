# 性能优化

## sql慢查询优化

### 原因

大多数情况下很正常，偶尔很慢：

1. 数据库在刷新脏页，例如`redo log`写满了需要同步到磁盘
2. 执行的时候，遇到锁，如表锁、行锁
3. `sql`语句写的烂

这一条`sql`语句一直执行地很慢：

1. 没有用上索引或者索引失效
2. 有索引有可能会走全盘扫描

#### 数据库中设置`SQL`慢查询

方式一：修改配置文件，主要是慢查询的定义时间，以及慢查询`log`日志记录

方式二：通过`MySQL`数据库开启慢查询



### 优化

#### 索引

- 尽量覆盖索引，5.6支持索引下推
- 组合索引符合最左匹配原则
- 避免索引失效
- 在写多读少的场景下，可以选择普通索引而不要唯一索引。更新时，普通索引可以使用change buffer进行优化，减少磁盘IO，将更新操作记录到change buffer，等查询来了将数据读到内存再进行修改。
- 索引建立原则
  - 根据查询频率建立（`where`条件频繁使用）
  - 优先考虑选择性高的字段
  - 避免对低选择性字段建索引
  - 支持排序和分组（`order by`）

#### `sql`语句

1. 分页查询优化

   对于主键自增的表，可以把`Limit`查询转换成某个位置的查询。

2. 优化`insert`语句

   - 多条插入语句写成一条，减少网络和事务开销
   - 使用事务批量提交

#### 数据库结构优化

1. 将字段多的表分解成多个表，有些字段使用频率高，有些低，数据量大时，会由于使用频率低的存在而变慢，可以考虑分开
2. 对于经常联合查询的表，可以考虑建立中间表



