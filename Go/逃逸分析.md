# 逃逸分析

> 逃逸分析是编译器用于决定变量分配到堆上还是栈上的一种行为。

栈上面的变量在函数结束的时候会自动回收，回收代价比较小。而堆分配内存，首先需要找到一块大小合适的内存，之后通过`GC`回收才能释放，频繁使用垃圾回收会占用比较大的内存开销，所以尽量分配内存到栈上。

### 逃逸分析过程

编译器根据变量是否被外部引用来决定是否逃逸分析：

- 如果函数外部没有引用，则优先放到栈中
- 如果函数外部存在引用，则必定放到堆中



以下情况会产生逃逸分析：

1. 指针逃逸，函数内部返回一个局部变量指针
2. 栈空间不足以存放当前对象时或无法判断当前切片长度时
3. 函数参数类型为interface类型，编译期间很难确定参数类型
4. 变量大小不确定



### 如何避免

1. 对于性能要求比较高且访问频次比较高的函数调用，应该尽量避免使用接口类型
2. 由于切片一般都是使用在函数传递的场景下，而且切片在 append 的时候可能会涉及到重新分配内存，如果切片在编译期间的大小不能够确认或者大小超出栈的限制，多数情况下都会分配到堆上