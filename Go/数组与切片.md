# 数组与切片

## 异同

- slice的底层数据是数组，slice是对数组的封装，它描述一个数组的片段。两者都可以通过下标来访问单个元素。

- 数组是定长的，长度定义好之后不能再更改。切片可以动态扩容。切片的类型和长度无关。

- 数组就是一片连续的内存，slice实际上是一个结构体。

  ```go
  // runtime/slice.go
  type slice struct {
  	array unsafe.Pointer // 元素指针
  	len   int // 长度 
  	cap   int // 容量
  }
  ```

  



## 切片的容量是怎样增长的

使用append可以向slice追加元素，实际上是往底层数组添加元素。但是底层数组的长度是固定的，当索引索引 len-1 所指向的元素已经是底层数组的最后一个元素，就没法再添加了。

这时，slice会迁移到新的内存位置，新底层数组的长度也会增加，这样就可以放置新增的元素。同时，为了应对未来可能再次发生的 append 操作，新的底层数组的长度，也就是新 slice 的容量是留了一定的 buffer 的。否则，每次添加元素的时候，都会发生迁移，成本太高。

golang 1.18版本之后，slice的扩容策略为：

> 当原slice容量(oldcap)小于256的时候，新slice(newcap)容量为原来的2倍；原slice容量超过256，新slice容量newcap = oldcap+(oldcap+3*256)/4

扩容之后还要对newcap作一个内存对齐。

