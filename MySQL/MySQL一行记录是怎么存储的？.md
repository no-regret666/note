# MySQL一行记录是怎么存储的？

### MySQL的数据存放在哪个文件？

我们每创建一个database（数据库）都会在`/var/lib/mysql/`目录里面创建一个以database为名的目录，然后保存表结构和表数据的文件都会存放在这个目录里。

比如，有一个名为my_test的database,该database里有一张名为t_order数据库表。

在/var/lib/mysql/my_test目录里，有三个文件：

- db.opt，用来存储当前数据库的默认字符集和字符校验规则
- t_order.frm，t_order的**表结构**会保存在这个文件
- t_order.ibd，t_order的**表数据**会保存在这个文件

一张数据库表的数据是保存在「 表名字.ibd 」的文件里的，这个文件也称为独占表空间文件。

### 表空间文件的结构是怎么样的？

从下往上：

1. 行（row）

   数据库表中的记录都是按行进行存放的

2. 页（page）

   InnoDB的数据是按「页」为单位来读写的，默认每个页的大小为 16KB

3. 区（extent）

   在表中数据量大的时候，为某个索引分配空间的时候就不再按照页为单位分配了，而是按照区（extent）为单位分配。每个区的大小为 1MB，对于 16KB 的页来说，连续的 64 个页会被划为一个区，这样就使得链表中相邻的页的物理位置也相邻，就能使用顺序 I/O 了。

4. 段（segment）

   段一般分为数据段、索引段和回滚段等。

   - 索引段：存放 B + 树的非叶子节点的区的集合；
   - 数据段：存放 B + 树的叶子节点的区的集合；
   - 回滚段：存放的是回滚数据的区的集合，之前讲事务隔离 (opens new window)的时候就介绍到了 MVCC 利用了回滚段实现了多版本查询数据。

### InnoDB行格式有哪些？

InnoDB 提供了 4 种行格式，分别是 Redundant（已废弃）、Compact、Dynamic和 Compressed 行格式。Dynamic 和 Compressed 这两个行格式跟 Compact 非常像。

### COMPACT行格式长什么样？

![img](/home/noregret/.config/Typora/typora-user-images/image-20250813102341031.png)

#### 记录的额外信息

1. 变长字段长度列表

   - 变长字段的真实数据占用的字节数会按照列的顺序**逆序存放**。

     > 是因为「记录头信息」中指向下一个记录的指针，指向的是下一条记录的「记录头信息」和「真实数据」之间的位置，这样的好处是向左读就是记录头信息，向右读就是真实数据
     >
     > 逆序存放可以使得位置靠前的记录的真实数据和数据对应的字段长度信息可以同时在一个 CPU Cache Line 中，这样就可以提高 CPU Cache 的命中率。

     > 当数据库没有变长字段的时候，比如全部都是int类型的字段，这时候表里的行格式就不会有「变长字段长度列表」了

   - NULL 是不会存放在行格式中记录的真实数据部分里的。

2. NULL值列表

   如果存在允许 NULL 值的列，则每个列对应一个二进制位（bit），二进制位按照列的顺序逆序排列。

   - 二进制位的值为1时，代表该列的值为NULL。

   - 二进制位的值为0时，代表该列的值不为NULL。

   另外，NULL 值列表必须用整数个字节的位表示（1字节8位），如果使用的二进制位个数不足整数个字节，则在字节的高位补 0。

   > 当数据表的字段都定义成 NOT NULL 的时候，这时候表里的行格式就不会有 NULL 值列表了。

3. 记录头信息

   - delete_mask：标识此条数据是否被删除
   - next_record：下一条记录的位置。指向的是下一条记录的「记录头信息」和「真实数据」之间的位置，这样的好处是向左读就是记录头信息，向右读就是真实数据，比较方便。

   - record_type：表示当前记录的类型，0表示普通记录，1表示B+树非叶子节点记录，2表示最小记录，3表示最大记录。
   - 等等

#### 记录的真实数据

记录真实数据部分除了我们定义的字段，还有三个隐藏字段，分别为：row_id、trx_id、roll_pointer

- row_id

  如果我们建表的时候指定了主键或者唯一约束列，那么就没有 row_id 隐藏字段了。如果既没有指定主键，又没有唯一约束，那么 InnoDB 就会为记录添加 row_id 隐藏字段。row_id不是必需的，占用 6 个字节。

- trx_id

  事务id，表示这个数据是由哪个事务生成的。 trx_id是必需的，占用 6 个字节。

- roll_pointer

  这条记录上一个版本的指针。roll_pointer 是必需的，占用 7 个字节。

### varchar(n) 中 n 最大取值为多少？

**MySQL 规定除了 TEXT、BLOBs 这种大对象类型之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过 65535 个字节。**

一行数据的最大字节数 65535，是包含「变长字段长度列表」和 「NULL 值列表」所占用的字节数的。

每个变长字段的「变长字段长度」需要用多少字节表示？具体情况分为：

- 条件一：如果变长字段允许存储的最大字节数小于等于 255 字节，就会用 1 字节表示「变长字段长度」；
- 条件二：如果变长字段允许存储的最大字节数大于 255 字节，就会用 2 字节表示「变长字段长度」；

### 行溢出后，MySQL 是怎么处理的？

行溢出，多的数据就会存到另外的「溢出页」中。

在记录的真实数据处只会保存该列的一部分数据，而把剩余的数据放在「溢出页」中，然后真实数据处用 20 字节存储指向溢出页的地址，从而可以找到剩余数据所在的页。

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/mysql/row_format/%E8%A1%8C%E6%BA%A2%E5%87%BA.png)

Compressed 和 Dynamic 这两个行格式和 Compact 非常类似，主要的区别在于处理行溢出数据时有些区别。

这两种格式采用完全的行溢出方式，记录的真实数据处不会存储该列的一部分数据，只存储 20 个字节的指针来指向溢出页。