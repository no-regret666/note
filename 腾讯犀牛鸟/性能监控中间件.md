# 性能监控中间件

性能监控：

- 定义：持续采集、度量与分析系统关键指标（如时延、吞吐、错误、并发/资源占用），以了解服务健康状况与瓶颈。
- 目的：发现异常与退化、定位问题原因、指导容量与优化、验证发布与SLO。
- 做法：在关键路径埋点，产出可聚合的指标（计数器/直方图/仪表盘），结合告警与看板持续观测。

在本项目中的含义：

- 每方法可观测：请求数、错误数、时延直方图、并发中请求
- 区分错误类型：业务错误（JSON-RPC Error.Code) 与系统错误（内部错误）
- 可扩展场景：传输层（HTTP）、工具/资源维度细分（控制标签基数）



### 总体设计

- 入口：

  ```go
  func NewMetricsMiddleware(recorder MetricsRecorder, opts ...func(*MetricsOptions)) mcp.MiddlewareFunc {
  	return func(ctx context.Context, req *mcp.JSONRPCRequest, session mcp.Session, next mcp.HandleFunc) (mcp.JSONRPCMessage, error) {
  		... // 调用下一层前
  		resp,err := next(ctx,req,session) // 调用下一层
  		... // 从下一层返回后
  	}
  }
  ```

- 接口：

  `middlewares.MetricsRecorder`作为适配器；

- 可拓展：可集成`Prometheus`等等



### 指标目录

- 请求总数：`requests_total{method}`
- 错误总数：`errors_total{method, code}`
- 时延直方图（毫秒）: `latency_ms_bucket/sum/count{method, success}`
- 并发中请求：`inflight{method}`



### 测试方案

- 单元测试： `middlewares/metrics_test.go`
  - 成功、next 返回 error、返回 JSONRPCError、Filter 生效、In-Flight 进出一致。
  - 覆盖开关关闭时不采集。
- 端到端：
  - 在 e2e/ 场景中挂载中间件，校验方法级指标增量与并发。





